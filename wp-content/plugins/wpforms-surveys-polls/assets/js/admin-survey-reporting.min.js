!function(o){"use strict";var n,s={settings:{fieldIDs:JSON.parse(wpforms_surveys.field_ids),fieldQueue:"",fieldData:{},charts:{},exportSelects:{}},init:function(){n=this.settings,Chart.defaults.global.defaultFontSize=14,Chart.plugins.register({beforeDraw:function(e){var t=e.chart.ctx;t.fillStyle="white",t.fillRect(0,0,e.chart.width,e.chart.height)}}),o(document).ready(s.ready),s.buildUIActions()},ready:function(){_.isEmpty(n.fieldIDs)||(n.fieldQueue=n.fieldIDs,_.isEmpty(wpforms_surveys_cache)?s.getFieldData():(n.fieldData=JSON.parse(wpforms_surveys_cache),s.generateReport()))},initExportChoices:function(){o(".survey-chart-export").each(function(){var e=o(this),t=e.data("id");n.exportSelects["export_"+t]=new Choices(e[0],{searchEnabled:!1,shouldSort:!1})})},buildUIActions:function(){o(document).on("click","#wpforms-survey-report .chart-toggle",function(e){e.preventDefault();var t=o(this),a=t.data("type"),r=t.hasClass("current"),i=t.parent(),e=i.data("field-id");r||(i.find(".current").removeClass("current"),t.addClass("current"),n.charts["chart_"+e].destroy(),n.charts["chart_hq_"+e].destroy(),s.generateChart(e,a,n.fieldData["field_"+e].chart.labels,n.fieldData["field_"+e].chart.data),s.generateChart(e,a,n.fieldData["field_"+e].chart.labels,n.fieldData["field_"+e].chart.data,!0))}),o(document).on("change","#wpforms-survey-preview-questions",function(){var e=o(this).val();n.fieldQueue=[],n.fieldData={},n.fieldQueue.push(e),o("#wpforms-survey-report").empty().prepend(wpforms_surveys.loader),s.getFieldData();e={action:"wpforms_surveys_set_preview_field",nonce:wpforms_admin.nonce,field_id:e,form_id:wpforms_surveys.form_id};o.post(wpforms_admin.ajax_url,e)}),o(document).on("change",".survey-chart-export",function(){var e,t,a=o(this),r=a.data("id");"jpg"===a.val()?((e=(t=o(" #chart-"+r+"-hq")[0]).getContext("2d")).globalCompositeOperation="destination-over",e.fillStyle="rgb(255,255,255)",e.fillRect(0,0,t.scrollWidth,t.scrollHeight),t=t.toDataURL("image/jpeg",1),o("#chart-"+r+"-download").attr("href",t),document.getElementById("chart-"+r+"-download").click()):"pdf"===a.val()?(t=o(" #chart-"+r+"-hq")[0].toDataURL("image/jpeg",1),t={pageSize:"LETTER",content:[{text:n.fieldData["field_"+r].question,fontSize:20,margin:[0,0,0,35]},{image:t,width:530}]},pdfMake.createPdf(t).download("chart-field-"+r+".pdf")):"print"===a.val()&&window.open(wpforms_surveys.print+"&field_id="+r),"1"!==a.val()&&n.exportSelects["export_"+r].setChoiceByValue("1")}),o(document).on("click",".form-details-print-survey-report",function(e){e.preventDefault(),window.open(o(this).attr("href"))}),o(document).on("click","#wpforms-survey-print-close",function(e){e.preventDefault(),window.close()}),o(document).on("click","#wpforms-survey-print",function(e){e.preventDefault(),window.print()}),o(document).on("click","#wpforms-survey-print-preview .question-toggle",function(e){e.preventDefault();var t=o(this),e=t.parent();t.find("i").toggleClass("fa-chevron-down fa-chevron-right"),e.toggleClass("no-print").find(".chart-area, .table-wrap, .stats, .no-answers").toggle()})},getFieldData:function(){var t=_.first(n.fieldQueue),e={action:"wpforms_surveys_field_data",nonce:wpforms_admin.nonce,form_id:wpforms_surveys.form_id,field_id:t,entry_count:wpforms_surveys.entry_count};o.post(wpforms_admin.ajax_url,e,function(e){return e.success?(WPFormsAdmin.debug(e.data),n.fieldData["field_"+e.data.id]=e.data,n.fieldQueue=_.without(n.fieldQueue,t),void(_.isEmpty(n.fieldQueue)?(s.cacheFieldData(),s.generateReport()):s.getFieldData())):(o("#wpforms-survey-loading").remove(),void o("#wpforms-survey-report").append(wpforms_surveys.l10n.fetch_error))})},cacheFieldData:function(){var e={action:"wpforms_surveys_cache_fields",nonce:wpforms_admin.nonce,field_data:JSON.stringify(n.fieldData),form_id:wpforms_surveys.form_id,field_id:wpforms_surveys.field_id,entry_count:wpforms_surveys.entry_count};o.post(wpforms_admin.ajax_url,e)},generateReport:function(){o("#wpforms-survey-loading").remove();var e=wp.template("wpforms-question-results");o("#wpforms-survey-report").append(e(n.fieldData)),o.each(n.fieldData,function(e,t){_.isEmpty(t.chart.data)||(s.generateChart(t.id,t.chart.default,t.chart.labels,t.chart.data),s.generateChart(t.id,t.chart.default,t.chart.labels,t.chart.data,!0))}),o(".wpforms-table-sorting").stupidtable(),s.initExportChoices(),"list"===wpforms_surveys.type&&o("#wpforms-survey-preview .btn-wrap").show()},generateChart:function(a,e,t,r,i){var o=!1,i=i||!1;"bar"===e?o={type:"bar",data:{labels:t,datasets:[{label:"Data",hoverBackgroundColor:"#2b8fd2",backgroundColor:"rgba(215, 215, 215, 0.65)",data:r}]},options:{responsive:!i,maintainAspectRatio:!1,legend:{display:!1},tooltips:{callbacks:{title:function(e,t){return t.labels[e[0].index]},label:function(e){return e.yLabel+"% ("+n.fieldData["field_"+a].chart.totals[e.index]+")"}}},scales:{xAxes:[{gridLines:{display:!1},ticks:{fontSize:i?20:14,callback:function(e){return"string"==typeof e&&20<e.length?e.substring(0,20)+"...":e}}}],yAxes:[{ticks:{min:0,max:100,stepSize:20,fontColor:"#999999",fontSize:i?20:11,callback:function(e){return e+"%"}}}]}}}:"bar-h"===e?o={type:"horizontalBar",data:{labels:t,datasets:[{label:"Data",hoverBackgroundColor:"#2b8fd2",backgroundColor:"rgba(215, 215, 215, 0.65)",data:r}]},options:{responsive:!i,maintainAspectRatio:!1,legend:{display:!1},tooltips:{callbacks:{title:function(e,t){return t.labels[e[0].index]},label:function(e){return e.xLabel+"% ("+n.fieldData["field_"+a].chart.totals[e.index]+")"}}},scales:{xAxes:[{ticks:{min:0,max:100,fontColor:"#999999",fontSize:i?20:11,callback:function(e){return e+"%"}}}],yAxes:[{gridLines:{display:!1},ticks:{fontSize:i?20:14,callback:function(e){return"string"==typeof e&&20<e.length?e.substring(0,20)+"...":e}}}]}}}:"pie"===e?o={type:"pie",data:{labels:t,datasets:[{hoverBackgroundColor:"#2b8fd2",data:r,backgroundColor:randomColor({luminosity:"light",count:r.length})}]},options:{responsive:!i,maintainAspectRatio:!1,legend:{position:"right",labels:{fontSize:i?20:14,padding:15,generateLabels:function(d){var c=d.data;return c.labels.length&&c.datasets.length?c.labels.map(function(e,t){var a=d.getDatasetMeta(0),r=c.datasets[0],i=a.data[t],o=i&&i.custom||{},n=Chart.helpers.valueAtIndexOrDefault,s=d.options.elements.arc,l=o.backgroundColor||n(r.backgroundColor,t,s.backgroundColor),i=o.borderColor||n(r.borderColor,t,s.borderColor),s=o.borderWidth||n(r.borderWidth,t,s.borderWidth);return 20<e.length&&(e=e.substring(0,20)+"..."),{text:e,fillStyle:l,strokeStyle:i,lineWidth:s,hidden:isNaN(r.data[t])||a.data[t].hidden,index:t}}):[]}}},tooltips:{callbacks:{label:function(e,t){return t.labels[e.index]+" - "+t.datasets[0].data[e.index]+"% ("+n.fieldData["field_"+a].chart.totals[e.index]+")"}}}}}:"line"===e&&(o={type:"line",data:{labels:t,datasets:[{label:"Data",borderColor:"#2b8fd2",backgroundColor:"rgba(215, 215, 215, 0.65)",fill:!1,data:r}]},options:{responsive:!i,maintainAspectRatio:!1,legend:{display:!1},tooltips:{callbacks:{title:function(e,t){return t.labels[e[0].index]},label:function(e){return e.yLabel+"% ("+n.fieldData["field_"+a].chart.totals[e.index]+")"}}},scales:{xAxes:[{gridLines:{display:!1},ticks:{fontSize:i?20:14,callback:function(e){return"string"==typeof e&&20<e.length?e.substring(0,20)+"...":e}}}],yAxes:[{ticks:{min:0,max:100,stepSize:20,fontColor:"#999999",fontSize:i?20:11,callback:function(e){return e+"%"}}}]}}}),o&&(i?n.charts["chart_hq_"+a]=new Chart("chart-"+a+"-hq",o):n.charts["chart_"+a]=new Chart("chart-"+a,o))}};s.init()}(jQuery);